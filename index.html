<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Sustain4METU ‚Äì Green Campus Tour</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #050816;
            color: #111827;
            height: 100vh;
            overflow: hidden;
        }

        .app {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ==== TOP BAR (always visible, clickable) ==== */
        .header {
            position: fixed;
            top: 12px;
            left: 12px;
            right: auto;
            z-index: 10000;
            pointer-events: auto;
        }

        .header-inner {
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            padding: 0.55rem 0.9rem;
            border-radius: 999px;
            display: inline-flex;
            flex-direction: column;
            gap: 0.15rem;
            backdrop-filter: blur(10px);
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(34, 197, 94, 0.25);
            user-select: none;
        }

        .title {
            font-size: 0.95rem;
            font-weight: 700;
            line-height: 1;
        }

        .subtitle {
            font-size: 0.7rem;
            opacity: 0.85;
        }

        /* ==== MAP ==== */
        .map-container {
            position: relative;
            flex: 1;
            overflow: hidden;
            transition: transform 0.35s ease, filter 0.35s ease;
        }

        .map-container.zoomed {
            transform: scale(1.02);
            filter: brightness(0.85);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ==== BOTTOM SHEET ==== */
        .sheet-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
            z-index: 30;
        }

        .sheet-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: -90%;
            background: #f9fafb;
            border-radius: 1.25rem 1.25rem 0 0;
            box-shadow: 0 -12px 40px rgba(15, 23, 42, 0.5);
            padding: 0.75rem 1rem 1rem;
            max-height: 60vh;
            /* default peek height */
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: bottom 0.3s ease, max-height 0.25s ease;
            z-index: 40;
        }

        .sheet.visible {
            bottom: 0;
        }

        /* expanded state (drag up) */
        .sheet.expanded {
            max-height: 95vh;
        }

        @media (max-width: 640px) {
            .sheet {
                max-height: 65vh;
            }
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            border-radius: 999px;
            background: #e5e7eb;
            margin: 0 auto 0.25rem;
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }

        .sheet-handle,
        .sheet-header {
            touch-action: none;
            /* let our JS handle the gesture */
        }

        .sheet-title {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }

        .sheet-tag {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            border: 1px solid #bbf7d0;
            color: #15803d;
            background: #dcfce7;
            white-space: nowrap;
        }

        .sheet-close {
            border: none;
            background: transparent;
            font-size: 1.25rem;
            line-height: 1;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
        }

        .sheet-body {
            font-size: 0.85rem;
            color: #374151;
            line-height: 1.4;
            overflow-y: auto;
            padding-right: 0.25rem;
            margin-top: 0.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sheet-image-wrapper {
            width: 100%;
            border-radius: 0.75rem;
            overflow: hidden;
            background: #e5e7eb;
            flex-shrink: 0;
        }

        .sheet-image-wrapper img {
            display: block;
            width: 100%;
            height: auto;
        }

        .sheet-text p+p {
            margin-top: 0.4rem;
        }

        .sheet-meta {
            margin-top: 0.1rem;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .sheet-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.35rem;
            padding-bottom: 0.2rem;
        }

        .sheet-citation {
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: #4b5563;
            font-style: italic;
        }


        .sheet-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            background: #eff6ff;
            color: #1d4ed8;
        }

        /* ==== EMOJI MARKERS ==== */
        .s4m-emoji-marker {
            width: 32px;
            height: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .s4m-emoji-marker .emoji-bubble {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.95);
            color: #bbf7d0;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.45);
            border: 2px solid rgba(15, 23, 42, 1);
            transition: transform 0.15s ease, filter 0.15s ease, box-shadow 0.15s ease;
        }

        .s4m-emoji-marker .pin-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            margin-top: 2px;
            background: #22d3ee;
            /* cyan accent */
            box-shadow: 0 0 12px rgba(34, 211, 238, 0.9);
            border: 1px solid #0f172a;
            /* dark ring */
        }

        .s4m-emoji-marker:hover .emoji-bubble {
            transform: translateY(-2px) scale(1.05);
            filter: brightness(1.1);
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.6);
        }

        /* Flicker animation */
        @keyframes markerFlicker {

            0%,
            100% {
                transform: scale(1);
                filter: brightness(1);
            }

            25% {
                transform: scale(1.08);
                filter: brightness(1.6);
            }

            50% {
                transform: scale(1);
                filter: brightness(1);
            }

            75% {
                transform: scale(1.08);
                filter: brightness(1.6);
            }
        }

        .s4m-emoji-marker.flicker .emoji-bubble,
        .s4m-emoji-marker.flicker .pin-dot {
            animation: markerFlicker 1s ease-in-out 1;
        }

        @media (min-width: 768px) {
            .title {
                font-size: 1.05rem;
            }

            .header-inner {
                flex-direction: row;
                align-items: center;
                gap: 0.6rem;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <!-- Top bar (click to flicker all pins) -->
        <div class="header">
            <div class="header-inner" id="topbar">
                <div class="title">Sustain4METU</div>
                <div class="subtitle">Interactive green ideas map ‚Äì tap a pin üå±</div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container" id="mapContainer">
            <div id="map"></div>
        </div>

        <!-- Backdrop + bottom sheet -->
        <div class="sheet-backdrop" id="sheetBackdrop"></div>

        <div class="sheet" id="sheet">
            <div class="sheet-handle"></div>
            <div class="sheet-header">
                <div class="sheet-title" id="sheetTitle">Title</div>
                <div class="sheet-tag" id="sheetTag">Idea</div>
                <button class="sheet-close" id="sheetClose" aria-label="Close">√ó</button>
            </div>

            <div class="sheet-body">
                <div class="sheet-image-wrapper" id="sheetImageWrapper">
                    <img id="sheetImage" src="" alt="Idea visual" />
                </div>
                <div class="sheet-text" id="sheetContent"></div>
                <div class="sheet-meta" id="sheetMeta"></div>
                <div class="sheet-badges" id="sheetBadges"></div>
                <div class="sheet-citation" id="sheetCitation"></div> <!-- NEW -->
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        /* ====== 1) DATA: your ideas ====== */
        const ideas = {
            library: {
                title: "Solar-Powered Library & Green Roof",
                tag: "Energy & Buildings",
                image: "images/library_roof.png",
                content: [
                    "Install solar panels on the main library roof to power lighting and study sockets.",
                    "Create a rooftop garden with native plants to reduce heat and offer a quiet study corner.",
                    "Place an interactive screen inside the library showing real-time energy production and approximate CO‚ÇÇ savings based on standard emission factors for grid electricity.",
                    "Libraries are high-use, long-hour buildings, so even covering part of the roof with solar can offset a noticeable share of their lighting and plug-load consumption over the year."
                ],
                meta: "Impact: visible flagship project, strong educational value, and direct CO‚ÇÇ reduction from on-site renewable energy.",
                badges: ["Solar", "Visibility", "Student Space"],
                emoji: "üìö"
            },

            dorms: {
                title: "Dorm Energy & Water Challenge",
                tag: "Student Life",
                image: "images/dorm_challenge.png",
                content: [
                    "Launch a friendly competition between dorms for electricity and water savings, using monthly meter readings as the basis.",
                    "Show weekly or monthly rankings on screens in each dorm and on Sustain4METU, so residents see how their dorm is performing in real time.",
                    "Reward the winning dorm with tree-planting in its name, common-area improvements, or experience-based prizes instead of material gifts.",
                    "Behaviour-change programs in universities often report energy savings in the 5‚Äì15% range when students receive regular feedback and light gamification, so even small shifts can add up quickly across many dorms."
                ],
                meta: "Impact: large-scale behaviour change with low cost, plus stronger community feeling around sustainability.",
                badges: ["Gamification", "Low Cost", "Behavior Change"],
                emoji: "üõèÔ∏è"
            },

            cafeteria: {
                title: "Low-Waste Cafeteria & Refill Stations",
                tag: "Food & Waste",
                image: "images/cafeteria_zero_waste.png",
                content: [
                    "Introduce clearly marked recycling and organic waste separation points in cafeterias, with icons and colours instead of only text.",
                    "Offer a discount system for reusable cups and food containers, and add water refill stations so students do not need single-use plastic bottles.",
                    "Pilot a weekly 'Low-Carbon Menu' day with more plant-based options and a small note that compares their approximate climate impact to standard meals using typical life-cycle estimate ranges.",
                    "University case studies show that simple nudges like reusable discounts and clear bins can significantly increase recycling rates and reduce food and packaging waste."
                ],
                meta: "Impact: lower waste and emissions in a place almost every student uses daily, plus built-in climate education.",
                badges: ["Zero Waste", "Food", "Awareness"],
                emoji: "üçΩÔ∏è"
            },

            compost_forest: {
                title: "Compost from Campus Green Waste",
                tag: "Waste & Soil",
                image: "images/compost_forest.png",
                content: [
                    "Convert pruning waste, fallen leaves, and lawn-mowing residues from METU‚Äôs green areas into compost instead of sending them away as mixed waste.",
                    "Set up a small composting area near forested zones: collected plant waste is shredded, piled, and regularly turned to produce nutrient-rich compost in a few months.",
                    "Use the compost to nourish campus trees, flower beds, and new saplings ‚Äì closing the loop on green waste generated on campus.",
                    "Composting organic waste instead of landfilling it also avoids methane emissions, which climate science identifies as a much more powerful greenhouse gas than CO‚ÇÇ on a per-molecule basis.",
                    "Even if METU produced just 10 tons of green waste per year, that could turn into several tons of compost and avoid both disposal costs and extra emissions."
                ],
                meta: "Impact: waste reduction, healthier soils, and lower methane emissions from organic waste disposal.",
                badges: ["Compost", "Circular Economy", "Soil Health"],
                emoji: "üå≥"
            },

            microalgae_bio: {
                title: "Microalgae Photobioreactor at Biology",
                tag: "Carbon & Air",
                image: "images/microalgae_reactor.png",
                content: [
                    "Develop a panel-type microalgae photobioreactor near the Biology department, where algae are already part of the academic and research work.",
                    "Microalgae can capture CO‚ÇÇ very efficiently in a small footprint, turning light and CO‚ÇÇ into biomass while releasing oxygen.",
                    "The reactor can include a small info board explaining how algae photosynthesis works and showing approximate CO‚ÇÇ captured daily using standard assumptions from microalgae literature (e.g., microalgae can fix several times more CO‚ÇÇ per unit area than many terrestrial plants) (Klinthong et al., 2015).",
                    "Reviews of microalgal systems indicate they can fix several times more CO‚ÇÇ per unit area than many terrestrial plants, making them ideal for tight campus locations (Ashour et al., 2024).",
                    "The system could be used in lab courses or student projects, integrating sustainability directly into teaching and not just as a decorative installation."
                ],
                meta: "Impact: visible science-based climate solution; reduced CO‚ÇÇ, increased O‚ÇÇ, and air-quality awareness around the department.",
                badges: ["Microalgae", "Carbon Capture", "STEM Education"],
                emoji: "üß™",
                citation: "Klinthong, W., & al. (2015). Microalgae and Their Applications in CO2 Capture and Utilization. Aerosol and Air Quality Research, 15, 712-742. & Ashour, M. (2024). Usage of Chlorella and diverse microalgae for CO2 capture. Frontiers in Plant Science."
            },

            battery_boxes: {
                title: "Battery Waste Collection Points",
                tag: "Recycling & Hazardous Waste",
                image: "images/battery_collection_box.png",
                content: [
                    "Place battery waste collection boxes in strategic locations: libraries, cafeterias, dorm lobbies, and main faculty buildings.",
                    "Used batteries contain heavy metals and chemicals; if thrown into regular trash, they can leak into soil and water and also increase fire risk in mixed waste streams.",
                    "Collected batteries can be periodically sent to authorized recycling facilities, in line with national hazardous waste regulations.",
                    "Clear signage in Turkish and English can explain what can be thrown inside and why separate battery collection matters for human health and ecosystems.",
                    "Environmental studies on spent batteries consistently show that improper disposal leads to contamination of soil, water, and air with toxic metals, so each full collection box represents a direct risk avoided."
                ],
                meta: "Impact: prevention of soil and water pollution, safer waste streams, and better recycling habits across campus.",
                badges: ["Battery Recycling", "Hazardous Waste", "Awareness"],
                emoji: "üîã"
            },

            electric_shuttle: {
                title: "Electric Campus Shuttle System",
                tag: "Transport & Mobility",
                image: "images/electric_shuttle_bus.png",
                content: [
                    "Gradually convert the current diesel shuttle buses on METU campus into an all-electric shuttle system.",
                    "Electric buses reduce tailpipe emissions to zero on campus, which means cleaner air, less particulate matter, and a quieter environment for pedestrians and cyclists.",
                    "Real-world measurements of conventional diesel buses show CO‚ÇÇ emissions on the order of hundreds of grams per kilometer; even a single busy line that runs around 50,000 km per year could avoid tens of tons of CO‚ÇÇ annually when electrified and supplied by a relatively low-carbon grid.",
                    "Charging stations can be placed at shuttle depots and major stops for opportunity charging, supported by rooftop solar on depots and parking structures where possible.",
                    "Route maps and stops can include a note: ‚ÄúYou are currently riding an electric shuttle ‚Äì estimated annual CO‚ÇÇ avoided: ___ tons,‚Äù making the climate benefit visible instead of invisible."
                ],
                meta: "Impact: reduced air pollution and noise, lower CO‚ÇÇ emissions, and a more comfortable campus for people walking and cycling.",
                badges: ["Electric Vehicles", "Air Quality", "Quiet Campus"],
                emoji: "üöå"
            },

            rainwater_system: {
                title: "Rainwater Collection for Toilets & Irrigation",
                tag: "Water & Resilience",
                image: "images/rainwater_roof_tank.png",
                content: [
                    "Install rainwater collection systems on large-roof buildings like faculties, the library, or sports halls.",
                    "Rainwater from roofs is filtered and stored in tanks, then used for toilet flushing or irrigation of green areas instead of treated drinking water.",
                    "A common engineering rule-of-thumb is: collected rainwater (litres) ‚âà roof area (m¬≤) √ó annual rainfall (mm) √ó 0.8‚Äì0.9, depending on system losses.",
                    "If a 1,000 m¬≤ roof in Ankara receives roughly 400 mm of rain annually, it could harvest on the order of 300,000‚Äì360,000 litres of water per year, enough for a significant share of toilet flushing or irrigation for that building.",
                    "The system can be monitored so students can see how many litres of rainwater have been reused and how much treated mains water has been saved over the year."
                ],
                meta: "Impact: reduced potable water consumption, lower water bills, and improved resilience to drought and climate change.",
                badges: ["Water Saving", "Infrastructure", "Climate Adaptation"],
                emoji: "üíß"
            },

            kindergarten_garden: {
                title: "Rainwater & Mini-Garden at METU Kindergarten",
                tag: "Education & Kids",
                image: "images/kindergarten_rain_garden.png",
                content: [
                    "Create a small rainwater collection system specifically for METU kindergarten, connected to a mini vegetable or flower garden.",
                    "Children can collect rainwater in a tank or barrels and use it to water their own small garden plot, learning about the water cycle, seasons, and sustainability in a playful way.",
                    "They can grow simple crops (lettuce, herbs, or flowers) and see how natural resources are reused instead of wasted.",
                    "Teachers can integrate simple observations into class: measuring rainfall in a gauge, counting how many watering cans come from a full barrel, or drawing the water cycle together.",
                    "This early recycling and sustainability education helps children build lifelong habits of environmental responsibility and shows visiting parents that METU takes climate education seriously."
                ],
                meta: "Impact: early sustainability education, hands-on learning, and a visible symbol of green values on campus.",
                badges: ["Kids", "Rainwater", "Environmental Education"],
                emoji: "üå±"
            },

            motion_sensors: {
                title: "Motion Sensor Lighting in Campus Buildings",
                tag: "Energy Efficiency",
                image: "images/motion_sensor_lighting.png",
                content: [
                    "Install motion sensor lights in restrooms, corridors, storage rooms, and other low-occupancy areas across faculties and administrative buildings.",
                    "Lights turn on only when someone is present and switch off automatically after a short period of inactivity, eliminating unnecessary electricity use when spaces are empty.",
                    "If a corridor‚Äôs lights are currently left on 24/7, motion sensors can cut lighting energy use dramatically, especially during nights, weekends, and semester breaks.",
                    "Studies on occupancy-based lighting controls in offices and corridors report average lighting energy savings in the range of roughly 20-60% (de Bakker & Long, 2017).",
                    "Sensors can be combined with LED bulbs and daylight sensors to maximize savings, and reduce both electricity bills and maintenance costs over time."
                ],
                meta: "Impact: lower electricity consumption, reduced carbon emissions from campus energy use, and smarter building operation.",
                badges: ["Energy Saving", "Smart Campus", "Automation"],
                emoji: "üí°",
                citation: "de Bakker, C., & Long, N. (2017). The Energy Saving Potential of Occupancy-Based Lighting Control Strategies. Energies, 11(1), 2."
            },

            solar_chargers: {
                title: "Solar-Powered Charging Stations",
                tag: "Energy & Student Life",
                image: "images/solar_charging_station.png",
                content: [
                    "Develop solar-powered charging stations near the library, dorm areas, and student gathering spots so students can charge phones and laptops using clean energy.",
                    "Growing use of mobile phones, tablets, and laptops in libraries and study spaces creates high demand for plugs; solar stations take some of this load off the main grid.",
                    "Even a modest solar array can generate enough electricity over a year to charge thousands of phones or hundreds of laptop cycles, using typical phone/laptop battery sizes for rough calculations.",
                    "Stations can display how many watt-hours they have produced in a day and how much CO‚ÇÇ has been avoided compared to conventional electricity, using simple approximate emission factors.",
                    "Smaller solar modules can also be installed near the kindergarten garden so kids see that their devices and pumps can be powered directly by the sun."
                ],
                meta: "Impact: decreased campus electricity usage, lower carbon footprint, and improved access to sustainable charging for students.",
                badges: ["Solar", "Student-Friendly", "Resilient Energy"],
                emoji: "üîå"
            },

            bike_infra: {
                title: "Bike Lanes & Repair Stations",
                tag: "Transport & Health",
                image: "images/bike_infrastructure.png",
                content: [
                    "Design safer bike lanes and clear wayfinding for cycling routes between dorms, main faculties, the library, and major gates of METU.",
                    "Add covered, secure bike parking near building entrances instead of leaving bikes randomly on railings and stairs.",
                    "Install simple bike repair stations with pumps and basic tools at a few key intersections so students can fix flat tires or adjust brakes on the go.",
                    "Every short trip shifted from car or shuttle to bicycle avoids local tailpipe emissions, reduces congestion, and improves student health through daily movement.",
                    "Campus transport studies in many universities show that good cycling infrastructure plus safe parking can significantly increase the share of trips made by bike rather than by car."
                ],
                meta: "Impact: lower transport emissions, healthier students, and a campus that feels comfortable at human speed instead of car speed.",
                badges: ["Cycling", "Active Mobility", "Low Carbon"],
                emoji: "üö≤",
                citation: "Naseri, H., & al. (2025). Cycling and GHG Emissions: How Infrastructure Makes All the Difference. Sustainability, 17(17), 7577. & Ta≈ütan, H., & Doƒüruer, S. M. (2025). Developing Awareness about the Role of Cycling Infrastructure in Sustainability: Experiences from Architectural Design Studio. Journal of Design Studio, 7(1), 237-242."
            },

            native_plants: {
                title: "Native, Low-Water Landscaping",
                tag: "Biodiversity & Water",
                image: "images/native_plants_garden.png",
                content: [
                    "Gradually replace some high-maintenance lawns with native plant beds that need less irrigation and support local biodiversity.",
                    "Native species are better adapted to local climate and rainfall patterns, reducing the need for chemical fertilizers and frequent watering.",
                    "Signs can explain which species are native or pollinator-friendly and why they were chosen, turning everyday pathways into small open-air ecology lessons.",
                    "Combined with rainwater harvesting and mulching, native plantings can significantly reduce landscape water demand and maintenance time for campus staff.",
                    "Research on xeriscaping and native landscaping in dry or semi-dry climates reports noticeable reductions in irrigation needs compared to traditional lawns."
                ],
                meta: "Impact: more resilient green spaces, higher biodiversity, and reduced irrigation and maintenance costs.",
                badges: ["Biodiversity", "Water Saving", "Landscape"],
                emoji: "ü¶ã"
            },

            digital_campus: {
                title: "Digital-First, Low-Paper Campus",
                tag: "Resources & IT",
                image: "images/digital_campus_low_paper.png",
                content: [
                    "Promote a digital-first approach for assignments, reports, and internal documents to drastically cut paper consumption across METU.",
                    "Set default printer settings to double-sided and black-and-white in libraries and computer labs, with a gentle message reminding users of the environmental impact of printing.",
                    "Encourage the use of learning management systems for submissions and feedback, and centralize important forms online instead of printed copies at multiple offices.",
                    "If a typical student currently uses hundreds of sheets per semester, even a 30‚Äì50% reduction across thousands of students would mean tens of thousands fewer pages printed each term, equivalent to many trees‚Äô worth of fibre and ink savings.",
                    "Public dashboards can show approximate paper savings, equivalent number of trees spared, and reduced waste compared to a baseline year before the digital-first initiative."
                ],
                meta: "Impact: lower paper use, reduced printing costs, and a more modern, efficient academic workflow.",
                badges: ["Paper Saving", "IT Systems", "Behaviour Change"],
                emoji: "üñ®Ô∏è"
            }
        };


        /* ====== 2) Element refs ====== */
        const mapContainer = document.getElementById("mapContainer");
        const sheet = document.getElementById("sheet");
        const sheetBackdrop = document.getElementById("sheetBackdrop");
        const sheetTitle = document.getElementById("sheetTitle");
        const sheetTag = document.getElementById("sheetTag");
        const sheetContent = document.getElementById("sheetContent");
        const sheetMeta = document.getElementById("sheetMeta");
        const sheetBadges = document.getElementById("sheetBadges");
        const sheetCitation = document.getElementById("sheetCitation"); // <!-- NEW -->
        const sheetClose = document.getElementById("sheetClose");
        const sheetImageWrapper = document.getElementById("sheetImageWrapper");
        const sheetImage = document.getElementById("sheetImage");
        const sheetHandle = document.querySelector(".sheet-handle");
        const sheetHeader = document.querySelector(".sheet-header");
        const topbar = document.getElementById("topbar");

        // Hide image wrapper if image fails to load
        sheetImage.addEventListener("error", () => {
            sheetImageWrapper.style.display = "none";
        });

        /* ====== 3) Sheet open/close ====== */
        function openSheet(ideaId) {
            const idea = ideas[ideaId];
            if (!idea) return;

            sheetTitle.textContent = idea.title;
            sheetTag.textContent = idea.tag || "Idea";

            if (idea.image) {
                sheetImage.src = idea.image;
                sheetImageWrapper.style.display = "block";
            } else {
                sheetImageWrapper.style.display = "none";
                sheetImage.src = "";
            }

            sheetContent.innerHTML = "";
            (idea.content || []).forEach(p => {
                const el = document.createElement("p");
                el.textContent = p;
                sheetContent.appendChild(el);
            });

            sheetMeta.textContent = idea.meta || "";

            sheetBadges.innerHTML = "";
            (idea.badges || []).forEach(b => {
                const span = document.createElement("span");
                span.className = "sheet-badge";
                span.textContent = b;
                sheetBadges.appendChild(span);
            });

            // Citation (APA) if provided
            if (idea.citation) {
                sheetCitation.textContent = "Source: " + idea.citation;
                sheetCitation.style.display = "block";
            } else {
                sheetCitation.textContent = "";
                sheetCitation.style.display = "none";
            }

            // reset to peek state on every open
            sheet.classList.remove("expanded");
            sheet.classList.add("visible");
            sheetBackdrop.classList.add("visible");
            mapContainer.classList.add("zoomed");
        }

        function closeSheet() {
            sheet.classList.remove("visible");
            sheet.classList.remove("expanded");
            sheetBackdrop.classList.remove("visible");
            mapContainer.classList.remove("zoomed");
        }

        sheetClose.addEventListener("click", closeSheet);
        sheetBackdrop.addEventListener("click", closeSheet);
        document.addEventListener("keydown", e => {
            if (e.key === "Escape") closeSheet();
        });

        /* ====== 4) Drag-to-expand / close (improved) ====== */
        let dragStartY = null;
        let dragging = false;

        function getY(evt) {
            return evt.touches ? evt.touches[0].clientY : evt.clientY;
        }

        function onDragStart(evt) {
            dragging = true;
            dragStartY = getY(evt);
        }

        function onDragMove(evt) {
            if (!dragging || dragStartY === null) return;
            // Prevent the page from scrolling while we drag the sheet
            if (evt.cancelable) evt.preventDefault();
        }

        function onDragEnd(evt) {
            if (!dragging || dragStartY === null) {
                dragging = false;
                dragStartY = null;
                return;
            }

            const endY = getY(evt);
            const delta = dragStartY - endY; // positive = moved up

            const THRESHOLD = 10; // smaller threshold so small drags still count

            if (delta > THRESHOLD) {
                // drag up -> expand
                sheet.classList.add("expanded");
            } else if (delta < -THRESHOLD) {
                // drag down -> close
                closeSheet();
            }

            dragging = false;
            dragStartY = null;
        }

        // Attach events to handle + header (so a bigger drag area)
        [sheetHandle, sheetHeader].forEach(el => {
            el.addEventListener("touchstart", onDragStart, { passive: false });
            el.addEventListener("touchmove", onDragMove, { passive: false });
            el.addEventListener("touchend", onDragEnd);

            el.addEventListener("mousedown", onDragStart);
            el.addEventListener("mousemove", onDragMove);
            el.addEventListener("mouseup", onDragEnd);
        });


        /* ====== 5) Map init ====== */
        const metuCenter = [39.8905, 32.7800];

        const map = L.map("map", {
            center: metuCenter,
            zoom: 15,
            minZoom: 14,
            maxZoom: 18,
            zoomControl: false          // we'll add our own at bottom-left
        });

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        // zoom control bottom-left
        L.control.zoom({ position: "bottomleft" }).addTo(map);

        // restrict to METU area
        const bounds = L.latLngBounds(
            [39.882, 32.765],
            [39.899, 32.795]
        );
        map.setMaxBounds(bounds);
        map.on("drag", () => {
            map.panInsideBounds(bounds, { animate: false });
        });

        /* ====== 6) Emoji markers + flicker ====== */
        const markers = [];

        function emojiIcon(emojiChar) {
            return L.divIcon({
                className: "s4m-emoji-marker",
                html: `
        <div class="emoji-bubble">${emojiChar || "üìç"}</div>
        <div class="pin-dot"></div>
      `,
                iconSize: [32, 40],
                iconAnchor: [16, 36]
            });
        }

        function addIdeaMarker(lat, lng, ideaId) {
            const emoji = ideas[ideaId]?.emoji || "üìç";
            const marker = L.marker([lat, lng], { icon: emojiIcon(emoji) }).addTo(map);
            marker.on("click", () => openSheet(ideaId));
            markers.push(marker);
        }

        // Core ideas
        addIdeaMarker(39.8922, 32.7791, "library");            // Library solar & green roof
        addIdeaMarker(39.8862, 32.7760, "dorms");              // Dorm energy & water challenge
        addIdeaMarker(39.8888, 32.7825, "cafeteria");          // Low-waste cafeteria & refill

        // Friend ideas
        addIdeaMarker(39.8950, 32.7765, "compost_forest");     // Compost from campus green waste
        addIdeaMarker(39.8900, 32.7850, "microalgae_bio");     // Microalgae photobioreactor
        addIdeaMarker(39.8890, 32.7790, "battery_boxes");      // Battery waste collection boxes
        addIdeaMarker(39.8870, 32.7720, "electric_shuttle");   // Electric campus shuttle system
        addIdeaMarker(39.8915, 32.7820, "rainwater_system");   // Rainwater for toilets & irrigation
        addIdeaMarker(39.8840, 32.7790, "kindergarten_garden");// Kindergarten rainwater mini-garden
        addIdeaMarker(39.8895, 32.7810, "motion_sensors");     // Motion sensor lighting in buildings
        addIdeaMarker(39.8910, 32.7780, "solar_chargers");     // Solar-powered charging stations

        // Extra ideas
        addIdeaMarker(39.8935, 32.7780, "bike_infra");         // Bike lanes & repair stations
        addIdeaMarker(39.8960, 32.7830, "native_plants");      // Native low-water landscaping
        addIdeaMarker(39.8898, 32.7835, "digital_campus");     // Digital-first low-paper campus


        function flickerPins() {
            markers.forEach(m => {
                const el = m.getElement();
                if (!el) return;
                el.classList.remove("flicker");
                void el.offsetWidth; // restart animation
                el.classList.add("flicker");
            });

            setTimeout(() => {
                markers.forEach(m => {
                    const el = m.getElement();
                    if (el) el.classList.remove("flicker");
                });
            }, 1100);
        }

        topbar.addEventListener("click", flickerPins);
    </script>
</body>

</html>